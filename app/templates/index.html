{% extends 'base.html' %}

{% block content %}
<!-- Hero Section -->
<div class="text-center mb-6 md:mb-10">
    <h1 class="text-3xl md:text-5xl font-extrabold text-white mb-3">
        Kenya University <span
            class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-indigo-400">Admissions Engine</span>.
    </h1>
    <p class="text-slate-400 text-base md:text-lg">
        Filter by Course, Cluster, or University. Analyze your chances.
    </p>
</div>

<!-- Command Center (Filter Deck) -->
<div
    class="bg-slate-800/80 backdrop-blur border border-slate-700 rounded-xl p-4 md:p-6 mb-6 md:mb-10 shadow-xl relative z-40">
    <!-- Header with Export Action -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4 sm:mb-6">
        <h2 class="text-white font-bold text-lg">Filters</h2>
        <div class="flex gap-2 w-full sm:w-auto">
            <a href="mailto:hanselnjago@gmail.com?subject=Enterprise%20Inquiry"
                class="flex-1 sm:flex-none justify-center bg-slate-700 hover:bg-slate-600 border border-slate-600 text-slate-300 px-4 py-2 rounded text-sm font-medium flex items-center gap-2 transition whitespace-nowrap">
                <i class="fa-solid fa-building-columns"></i> For Schools
            </a>
            <button id="btn-export" data-tier="premium"
                class="flex-1 sm:flex-none justify-center bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded text-sm font-medium flex items-center gap-2 transition whitespace-nowrap">
                <i class="fa-solid fa-file-csv"></i> Download
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">



        <!-- Dropdown 2: University -->
        <div>
            <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Universities</label>
            <select id="select-uni" multiple placeholder="All Universities..." autocomplete="off">
                <option value="">Loading...</option>
            </select>
        </div>

        <!-- Dropdown 3: Cluster -->
        <div>
            <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Clusters</label>
            <select id="select-cluster" multiple placeholder="All Clusters..." autocomplete="off">
                <option value="">Loading...</option>
            </select>
        </div>

        <!-- Input 4: My Points (Upsell Hook) -->
        <div
            class="md:col-span-3 border-t border-slate-700/50 pt-4 mt-2 flex flex-col md:flex-row md:items-center gap-4">
            <div class="w-full md:flex-grow">
                <label class="block text-xs font-bold text-emerald-400 uppercase mb-2"><i
                        class="fa-solid fa-calculator mr-1"></i> My Points (KCSE)</label>
                <input type="number" id="input-points" step="0.001" min="0" max="48" placeholder="e.g. 34.5 (Max 48)"
                    class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-emerald-500/50 outline-none transition">

                <!-- Dynamic Per-Cluster Points -->
                <div id="dynamic-points-container" class="space-y-3 mt-3 hidden"></div>

                <!-- Reach Toggle -->
                <div class="flex items-center mt-3 px-1">
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="check-reach" class="sr-only peer">
                        <div
                            class="w-9 h-5 bg-slate-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-emerald-500/50 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-emerald-500">
                        </div>
                        <span class="ml-2 text-sm font-medium text-slate-300 flex items-center">
                            Show "Reach" Options (+2 pts)
                            <!-- Free for all now -->
                        </span>
                    </label>
                </div>
            </div>
            <div class="w-full md:w-auto md:flex-shrink-0 pt-0 md:pt-6 text-left">
                <span class="text-slate-500 text-xs md:text-sm">Enter points to see <span
                        class="text-emerald-400 font-bold">Safety Analysis</span></span>
            </div>
        </div>
    </div>
</div>

<!-- Comparison Tray (Pinned) -->
<div id="comparison-tray" class="hidden mb-8 p-4 bg-slate-800/50 rounded-lg border border-blue-500/20 shadow-inner">
    <div class="flex justify-between items-center mb-3">
        <h3 class="text-sm font-bold text-blue-200 uppercase tracking-wider flex items-center">
            <i class="fa-solid fa-scale-balanced mr-2"></i> Comparing (<span id="tray-count">0</span>/4)
        </h3>
        <button onclick="openCompareModal()"
            class="text-xs bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded font-bold shadow-lg transition transform hover:scale-105">
            View Comparison
        </button>
    </div>
    <div id="tray-items" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Pinned Items Injected Here -->
    </div>
</div>

<!-- Results Grid Container -->
<div id="results-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-20 min-h-[300px]">
    {% include 'results_partial.html' %}
</div>

<!-- Upgrade Modal / Section (Hidden by default or shown if Basic) -->
<!-- Premium Features section removed. Now free. -->

<!-- FAB Removed -->

<!-- Comparison Modal -->
<div id="modal-compare" class="fixed inset-0 z-[60] hidden" aria-labelledby="modal-title" role="dialog"
    aria-modal="true">
    <!-- Backdrop -->
    <div class="fixed inset-0 bg-slate-900/90 backdrop-blur transition-opacity"></div>

    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
            <div
                class="relative transform overflow-hidden rounded-lg bg-slate-800 border border-slate-700 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-4xl">

                <!-- Header -->
                <div class="bg-slate-900 px-4 py-3 sm:px-6 flex justify-between items-center border-b border-slate-700">
                    <h3 class="text-base font-semibold leading-6 text-white" id="modal-title">Course Comparison</h3>
                    <button onclick="closeCompareModal()" class="text-slate-400 hover:text-white transition">
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>
                </div>

                <!-- Content -->
                <div class="px-0 py-0 sm:p-6 overflow-hidden bg-slate-800">
                    <div class="flex text-center border border-slate-700 rounded-lg overflow-hidden relative">
                        <!-- Labels Column (Sticky Left) -->
                        <div
                            class="w-24 md:w-32 flex-shrink-0 bg-slate-900/90 backdrop-blur z-20 border-r border-slate-700 font-bold text-xs space-y-4 py-4 sticky left-0 shadow-lg">
                            <div class="h-14 flex items-center justify-end pr-2 md:pr-4 text-slate-400 uppercase">
                                Programme</div>
                            <div class="h-12 flex items-center justify-end pr-2 md:pr-4 text-slate-400 uppercase">
                                Institution</div>
                            <div class="h-12 flex items-center justify-end pr-2 md:pr-4 text-slate-400 uppercase">Cutoff
                            </div>
                            <div class="h-12 flex items-center justify-end pr-2 md:pr-4 text-slate-400 uppercase">Gap
                            </div>
                            <div class="h-12 flex items-center justify-end pr-2 md:pr-4 text-slate-400 uppercase">
                                Cluster</div>
                        </div>

                        <!-- Scrollable Courses Area -->
                        <div class="flex-1 overflow-x-auto custom-scrollbar bg-slate-800">
                            <div class="flex min-w-min" id="compare-container">
                                <!-- Dynamic Columns go here -->
                            </div>
                        </div>
                    </div>
                    <div class="text-center mt-2 text-xs text-slate-500 md:hidden">
                        <i class="fa-solid fa-arrows-left-right mr-1"></i> Swipe to see more
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Forecast Modal -->
<div id="modal-forecast" class="fixed inset-0 z-[70] hidden" aria-labelledby="modal-title" role="dialog"
    aria-modal="true">
    <!-- Backdrop -->
    <div class="fixed inset-0 bg-slate-900/95 backdrop-blur-sm transition-opacity" onclick="closeForecast()"></div>

    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
            <div
                class="relative transform overflow-hidden rounded-xl bg-slate-800 border border-slate-700 text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-3xl">

                <!-- Header -->
                <div class="bg-slate-900/50 px-6 py-4 flex justify-between items-start border-b border-slate-700">
                    <div>
                        <h3 class="text-lg font-bold text-white leading-tight mb-1" id="forecast-title">Course Name</h3>
                        <p class="text-sm text-slate-400" id="forecast-inst">Institution</p>
                    </div>
                    <button onclick="closeForecast()" class="text-slate-500 hover:text-white transition p-1">
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>
                </div>

                <!-- Chart Area -->
                <div class="px-6 py-6 bg-slate-800">
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-xs font-bold text-slate-500 uppercase tracking-wider">Historical Cutoffs
                            (2018-2024)</span>
                        <span id="forecast-trend"
                            class="text-xs font-bold px-2 py-1 rounded bg-slate-900 border border-slate-700">Trend</span>
                    </div>

                    <div class="h-[300px] w-full bg-slate-900/50 rounded-lg border border-slate-700/50 p-2">
                        <canvas id="chart-forecast-canvas"></canvas>
                    </div>

                    <div class="mt-4 text-center">
                        <p class="text-xs text-slate-500">
                            <i class="fa-solid fa-circle-info mr-1"></i> Data is based on reported KUCCPS cutoffs.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Search JS -->
<script>
    const USER_TIER = "{{ g.user['tier'] if g.user else 'basic' }}";
</script>
<script src="{{ url_for('static', filename='js/search.js') }}"></script>

<!-- Forecast Modal Logic -->
<script>
    let forecastChart = null;

    function openForecast(btn) {
        const modal = document.getElementById('modal-forecast');
        const titleEl = document.getElementById('forecast-title');
        const instEl = document.getElementById('forecast-inst');
        const trendEl = document.getElementById('forecast-trend');

        // Parse Data
        const name = btn.dataset.name;
        const inst = btn.dataset.inst;
        const trend = btn.dataset.trend;
        const history = JSON.parse(btn.dataset.history);
        const labels = JSON.parse(btn.dataset.labels);

        // Set Text
        titleEl.innerText = name;
        instEl.innerText = inst;
        trendEl.innerText = trend;

        // Color Logic for Trend Badge
        if (trend.includes('Rising')) {
            trendEl.className = 'text-xs font-bold px-3 py-1 rounded bg-red-900/20 text-red-400 border border-red-500/20';
        } else if (trend.includes('Falling')) {
            trendEl.className = 'text-xs font-bold px-3 py-1 rounded bg-emerald-900/20 text-emerald-400 border border-emerald-500/20';
        } else {
            trendEl.className = 'text-xs font-bold px-3 py-1 rounded bg-slate-700 text-slate-300 border border-slate-600';
        }

        // Show Modal
        modal.classList.remove('hidden');

        // Render Chart
        const ctx = document.getElementById('chart-forecast-canvas').getContext('2d');

        if (forecastChart) {
            forecastChart.destroy();
        }

        forecastChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Cutoff Points',
                    data: history,
                    borderColor: trend.includes('Rising') ? '#ef4444' : (trend.includes('Falling') ? '#10b981' : '#f59e0b'),
                    backgroundColor: 'rgba(30, 41, 59, 0.4)',
                    borderWidth: 3,
                    tension: 0.3,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    pointBackgroundColor: '#fff',
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        enabled: true,
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(15, 23, 42, 0.95)',
                        titleColor: '#cbd5e1', // Slate-300
                        bodyColor: '#fff',
                        padding: 12,
                        cornerRadius: 8,
                        displayColors: false,
                        titleFont: { size: 14 },
                        bodyFont: { size: 16, weight: 'bold' }
                    }
                },
                scales: {
                    x: {
                        display: true,
                        ticks: { color: '#94a3b8', font: { size: 12 } },
                        grid: { display: false }
                    },
                    y: {
                        display: true,
                        ticks: { color: '#94a3b8', font: { size: 12 } },
                        grid: { color: '#334155', tickBorderDash: [2, 2] } // Dashed grid
                    }
                },
                layout: { padding: 20 }
            }
        });
    }

    function closeForecast() {
        document.getElementById('modal-forecast').classList.add('hidden');
    }
</script>
{% endblock %}